const fs = require("fs");
const path = require("path");

/**
 * Custom Markdown Reporter for Playwright
 * Generates a detailed test report in Markdown format
 */
class CustomMarkdownReporter {
  constructor() {
    this.results = [];
    this.startTime = null;
    this.endTime = null;
  }

  onBegin(config, suite) {
    this.startTime = new Date();
    console.log(
      `\nüöÄ Starting test run with ${suite.allTests().length} tests\n`
    );
  }

  onTestEnd(test, result) {
    const testResult = {
      title: test.title,
      status: result.status,
      duration: result.duration,
      error: result.error ? result.error.message : null,
      retry: result.retry,
      attachments: result.attachments || [],
    };

    this.results.push(testResult);

    const statusIcon =
      result.status === "passed"
        ? "‚úÖ"
        : result.status === "failed"
        ? "‚ùå"
        : result.status === "skipped"
        ? "‚è≠Ô∏è"
        : "‚ö†Ô∏è";

    console.log(`${statusIcon} ${test.title} (${result.duration}ms)`);
  }

  onEnd(result) {
    this.endTime = new Date();
    const totalDuration = this.endTime - this.startTime;

    const passed = this.results.filter((r) => r.status === "passed").length;
    const failed = this.results.filter((r) => r.status === "failed").length;
    const skipped = this.results.filter((r) => r.status === "skipped").length;

    // Generate Markdown Report
    let markdown = `# Tamil Transliteration Test Report\n\n`;
    markdown += `**Generated:** ${this.endTime.toISOString()}\n\n`;
    markdown += `## Summary\n\n`;
    markdown += `| Metric | Value |\n`;
    markdown += `|--------|-------|\n`;
    markdown += `| Total Tests | ${this.results.length} |\n`;
    markdown += `| ‚úÖ Passed | ${passed} |\n`;
    markdown += `| ‚ùå Failed | ${failed} |\n`;
    markdown += `| ‚è≠Ô∏è Skipped | ${skipped} |\n`;
    markdown += `| Total Duration | ${(totalDuration / 1000).toFixed(
      2
    )}s |\n\n`;

    // Positive Tests Section
    markdown += `## Positive Test Cases\n\n`;
    markdown += `| # | Test Name | Status | Duration |\n`;
    markdown += `|---|-----------|--------|----------|\n`;

    const positiveTests = this.results.filter((r) => r.title.includes("Pos_"));
    positiveTests.forEach((r, index) => {
      const statusIcon = r.status === "passed" ? "‚úÖ" : "‚ùå";
      markdown += `| ${index + 1} | ${r.title} | ${statusIcon} ${r.status} | ${
        r.duration
      }ms |\n`;
    });

    // Negative Tests Section
    markdown += `\n## Negative Test Cases\n\n`;
    markdown += `| # | Test Name | Status | Duration |\n`;
    markdown += `|---|-----------|--------|----------|\n`;

    const negativeTests = this.results.filter((r) => r.title.includes("Neg_"));
    negativeTests.forEach((r, index) => {
      const statusIcon = r.status === "passed" ? "‚úÖ" : "‚ùå";
      markdown += `| ${index + 1} | ${r.title} | ${statusIcon} ${r.status} | ${
        r.duration
      }ms |\n`;
    });

    // UI Tests Section
    markdown += `\n## UI Test Cases\n\n`;
    markdown += `| # | Test Name | Status | Duration |\n`;
    markdown += `|---|-----------|--------|----------|\n`;

    const uiTests = this.results.filter((r) => r.title.includes("UI_"));
    uiTests.forEach((r, index) => {
      const statusIcon = r.status === "passed" ? "‚úÖ" : "‚ùå";
      markdown += `| ${index + 1} | ${r.title} | ${statusIcon} ${r.status} | ${
        r.duration
      }ms |\n`;
    });

    // Failed Tests Details
    const failedTests = this.results.filter((r) => r.status === "failed");
    if (failedTests.length > 0) {
      markdown += `\n## Failed Tests Details\n\n`;
      failedTests.forEach((r, index) => {
        markdown += `### ${index + 1}. ${r.title}\n\n`;
        markdown += `- **Status:** ‚ùå Failed\n`;
        markdown += `- **Duration:** ${r.duration}ms\n`;
        markdown += `- **Error:** ${r.error || "Unknown error"}\n\n`;
      });
    }

    markdown += `\n---\n`;
    markdown += `*Report generated by Custom Markdown Reporter*\n`;

    // Write to file
    const reportPath = path.join(process.cwd(), "test-report.md");
    fs.writeFileSync(reportPath, markdown);

    console.log(`\nüìä Test run completed!`);
    console.log(`   ‚úÖ Passed: ${passed}`);
    console.log(`   ‚ùå Failed: ${failed}`);
    console.log(`   ‚è≠Ô∏è Skipped: ${skipped}`);
    console.log(`   ‚è±Ô∏è Duration: ${(totalDuration / 1000).toFixed(2)}s`);
    console.log(`\nüìÑ Report saved to: ${reportPath}\n`);
  }
}

module.exports = CustomMarkdownReporter;
